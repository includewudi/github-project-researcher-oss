# Step 6: Update Knowledge Base

> **返回索引:** [SKILL_FULL.md](../../SKILL_FULL.md)

**Self-Evolution Mechanism:**

After each research, update accumulated knowledge following KB Hygiene rules.

---

## 6.0 Pattern Worth Gate (MANDATORY before KB write)

Before writing ANY new pattern, ALL 5 questions must pass:

| # | Question | Fail → Action |
|---|----------|---------------|
| 1 | **Reusable across projects?** Would a DIFFERENT project benefit? | Skip — too project-specific |
| 2 | **Novel?** Is this pattern already in PATTERNS.md? | Skip — or LINK to existing (see 6.2) |
| 3 | **Named?** Can you give it a clear ≤5-word name? | Skip — too vague |
| 4 | **Architecture-level?** Is this a design pattern, not implementation detail? | Skip — belongs in RESEARCH.md only |
| 5 | **Future value?** Would a researcher 3 months from now benefit? | Skip — ephemeral |

**Throttle:** Max **3 new patterns** per project research.

---

## 6.1 KB Hygiene Rules (MANDATORY)

### 6.1.1 Append Minimal Non-Empty Entries Only

**Never** append empty template sections. Every field must have real content or be omitted.

```bash
# Append to knowledge base — ONLY non-empty fields
cat >> $CLONE_BASE/KNOWLEDGE_BASE.md << 'EOF'

## {Project Name} ({date})

**Verdict:** {one-line: Use / Avoid / Use with Caution — and why}
**Key Insight:** {the single most valuable thing learned}
**Reusable Pattern:** {code/architecture pattern worth remembering, or omit if none}
**Deep Dive:** [{Project} RESEARCH.md](./{author}/{repo}/RESEARCH.md)
**Tags:** {2-5 tags}
EOF
```

> **Rule:** If a field has no real content, **omit it entirely**. No "None found", no "N/A".

---

### 6.1.2 Maintain Compact Index Table at Top

Keep a `## Research Index` table at the top of KNOWLEDGE_BASE.md:

```markdown
## Research Index

| Date | Project | Type | Verdict | Tags | Deep Dive |
|------|---------|------|---------|------|-----------|
| 2025-01 | microsoft/qlib | code | ⚠️ Use with caution | quant, python, ml | [→](./microsoft/qlib/RESEARCH.md) |
```

---

### 6.1.3 Consolidation Pass

**Trigger:** Run consolidation when KB exceeds **100 lines** OR every **3 projects**.

Consolidation actions:
- Merge entries that share patterns → move to `PATTERNS.md`
- Remove any heading that has no content under it
- Convert repetitive per-project sections into tags + index rows
- Verify all Deep Dive links still resolve

---

### 6.1.4 Deep-Dive Navigation Rule

**Never** copy large appendices into KNOWLEDGE_BASE.md. Instead:
- KB gets: one-line verdict, key insight, tags, link
- RESEARCH.md keeps: all details, appendices, tables

---

### 6.1.5 Layered Storage: KB + PATTERNS.md

```
$CLONE_BASE/
├── KNOWLEDGE_BASE.md    # Index only (~50-80 lines)
└── PATTERNS.md          # Detailed patterns (~500+ lines)
```

**KNOWLEDGE_BASE.md** contains:
- `## 研究历史` — Index table
- `## 可复用模式` — Summary table linking to PATTERNS.md
- `## 深度参考` — Links to RESEARCH.md files

**PATTERNS.md** contains:
- Full pattern definitions with code examples
- Architecture diagrams
- Detailed implementation notes

---

## 6.2 Knowledge Linking (Cross-Project Pattern Dedup)

When a new project exhibits a pattern that is **already in PATTERNS.md**, do NOT duplicate it.

### 6.2.1 Link, Don't Duplicate

**Before adding a pattern**, scan existing `PATTERNS.md` entries:

1. **Append the new project as a source** to existing heading:

```markdown
## 客户端-守护进程 IPC 架构

**来源：** agent-browser, new-project
```

2. If the new project reveals **additional nuance**, append a sub-section:

```markdown
### new-project 变体

使用 gRPC 替代 Unix 域套接字。
```

3. If no new nuance — **just add the project name, no new content**.

---

## Location

```
$CLONE_BASE/KNOWLEDGE_BASE.md
$CLONE_BASE/PATTERNS.md
```
