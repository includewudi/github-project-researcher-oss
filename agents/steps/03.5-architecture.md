# Step 3.5: Architecture Analysis (Deep Dive)

> **返回索引:** [SKILL_FULL.md](../../SKILL_FULL.md)

**When to Use:** For complex projects where understanding internal design is critical.

This step was evolved from analyzing Microsoft Qlib's sophisticated architecture.

---

## 3.5.1 Identify Design Patterns

Read core files to discover architectural patterns. **Adapt commands to detected language:**

### Python

```bash
# Find entry points and core abstractions
find . -name "__init__.py" -o -name "base.py" -o -name "core.py" -o -name "main.py" | head -20

# Find class hierarchies
grep -r "class.*:" --include="*.py" . | grep -E "(Base|Abstract|Interface|Mixin)" | head -20

# Find factory/provider patterns
grep -r "register\|factory\|provider\|create_" --include="*.py" . | head -20
```

### JavaScript/TypeScript

```bash
# Find entry points
find . -name "index.ts" -o -name "index.js" -o -name "main.ts" -o -name "app.ts" | grep -v node_modules | head -20

# Find class hierarchies
grep -r "class.*extends\|implements" --include="*.ts" --include="*.tsx" . | grep -v node_modules | head -20

# Find factory/provider patterns
grep -r "createFactory\|Provider\|register\|useContext\|createContext" --include="*.ts" --include="*.tsx" . | grep -v node_modules | head -20
```

### Go

```bash
# Find entry points
find . -name "main.go" -o -name "cmd" -type d | grep -v vendor | head -20

# Find interfaces
grep -r "type.*interface {" --include="*.go" . | grep -v vendor | head -20

# Find factory patterns
grep -r "func New\|func Create" --include="*.go" . | grep -v vendor | head -20
```

### Rust

```bash
# Find entry points
find . -name "main.rs" -o -name "lib.rs" | grep -v target | head -20

# Find trait hierarchies
grep -r "pub trait\|impl.*for" --include="*.rs" . | grep -v target | head -20
```

> **For other languages:** Adapt patterns. Key targets: entry points, abstract base types, factory/builder methods, registration patterns.

---

## Common Patterns to Identify

| Pattern | How to Detect | Example |
|---------|---------------|---------|
| **Provider/Registry** | `register()`, global registry dict | `ProviderBackendMixin` |
| **Template Method** | Base class with abstract methods, `@abstractmethod` | `Model.fit()` |
| **Factory** | `create_*()`, `build_*()` functions | `R.get_recorder()` |
| **Strategy** | Interchangeable implementations, `set_*()` | `BaseStrategy` |
| **Decorator** | Wrapper classes, `__getattr__` delegation | Expression operators |
| **Expression Engine** | DSL parsing, operator overloading | `data.ops.Operators` |

---

## 3.5.2 Map Component Hierarchy

Generate ASCII component diagram:

```
Project Architecture
├── Core Layer
│   ├── Data Pipeline (data/)
│   │   ├── Provider abstraction
│   │   ├── Expression engine
│   │   └── Caching system
│   ├── Model Framework (model/)
│   │   ├── Base abstractions
│   │   └── Training pipeline
│   └── Workflow (workflow/)
│       └── Experiment tracking
├── Application Layer
│   ├── Strategy (strategy/)
│   ├── Backtest (backtest/)
│   └── RL Framework (rl/)
└── Contrib Layer (contrib/)
    └── Community implementations
```

---

## 3.5.3 Analyze Extension Points

Identify where users can extend the project:

| Extension Point | Location | How to Extend |
|-----------------|----------|---------------|
| Custom Data Provider | `data/data.py` | Inherit `BaseProvider`, register |
| Custom Model | `model/base.py` | Inherit `Model`, implement `fit()`/`predict()` |
| Custom Strategy | `strategy/base.py` | Inherit `BaseStrategy` |
| Custom Operators | `data/ops.py` | Add to `Operators` class |

---

## 3.5.4 Document Architecture in RESEARCH.md

Add this section to the research document:

```markdown
## Architecture Analysis

### Design Patterns Used

| Pattern | Location | Purpose |
|---------|----------|---------|
| {pattern} | {file/module} | {why used} |

### Component Hierarchy

{ASCII diagram}

### Extension Points

| Extension | Base Class | Example |
|-----------|------------|---------|
| {name} | {class} | {how to extend} |

### Key Abstractions

- **{Abstraction 1}**: {purpose and key methods}
- **{Abstraction 2}**: {purpose and key methods}
```
